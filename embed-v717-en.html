<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Packing Video Recording v7.17</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { font-family: 'Segoe UI', Arial, sans-serif; background: #1a1a2e; height: 100%; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .hidden { display: none !important; }
        /* HEADER */
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 15px; text-align: center; flex-shrink: 0; }
        .header h1 { font-size: 24px; }
        .header .subtitle { font-size: 13px; opacity: 0.9; }
        /* TABS */
        .tabs { display: flex; background: #16213e; border-bottom: 2px solid #667eea; flex-shrink: 0; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: transparent; border: none; font-size: 16px; color: #888; font-weight: 500; }
        .tab.active { background: #1a1a2e; color: #667eea; font-weight: 600; border-bottom: 3px solid #667eea; margin-bottom: -2px; }
        /* CONTROLS */
        .controls { padding: 8px 12px; background: #16213e; border-bottom: 1px solid #2a3f5f; flex-shrink: 0; }
        .control-row { display: flex; gap: 10px; margin-bottom: 6px; flex-wrap: wrap; }
        .control-group { flex: 1; min-width: 130px; }
        .control-group label { display: block; font-size: 13px; color: #aaa; margin-bottom: 3px; font-weight: 500; }
        select { width: 100%; padding: 6px 8px; border: 1px solid #3a4f6f; border-radius: 4px; font-size: 13px; background: #1a1a2e; color: white; }
        /* TOGGLE */
        .toggle-row { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .toggle { position: relative; width: 36px; height: 18px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #444; border-radius: 18px; transition: 0.3s; }
        .toggle-slider:before { content: ""; position: absolute; height: 14px; width: 14px; left: 2px; bottom: 2px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle input:checked + .toggle-slider { background: #667eea; }
        .toggle input:checked + .toggle-slider:before { transform: translateX(18px); }
        .toggle-label { font-size: 13px; color: #ccc; font-weight: 500; }
        /* BUTTONS */
        .buttons { display: flex; gap: 8px; padding: 8px 12px; background: #16213e; justify-content: center; flex-shrink: 0; }
        .btn { padding: 8px 16px; border: none; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-secondary { background: #f39c12; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-small { padding: 5px 12px; font-size: 12px; }
        /* FOLDER INFO */
        .folder-info { background: #1f3a5f; border: 1px solid #3a5f8f; border-radius: 5px; padding: 6px 10px; margin: 0 12px 5px; font-size: 12px; flex-shrink: 0; }
        .folder-info .title { font-weight: 600; color: #4dabf7; font-size: 13px; }
        .folder-info .path { background: #0d1520; padding: 4px 8px; border-radius: 4px; font-family: monospace; color: #7bed9f; font-size: 11px; }
        /* VIDEO SECTION */
        .video-section { position: relative; background: #000; width: 100%; flex: 1; min-height: 0; overflow: hidden; }
        #webcamVideo { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .video-overlay { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 6px; font-size: 13px; border-left: 3px solid #28a745; opacity: 0; transform: translateY(10px); transition: all 0.3s; }
        .video-overlay.show { opacity: 1; transform: translateY(0); }
        .video-overlay h4 { font-size: 14px; margin-bottom: 3px; }
        .video-overlay strong { color: #ffd700; }
        .rec-indicator { position: absolute; top: 10px; left: 10px; background: rgba(255,0,0,0.9); color: white; padding: 5px 12px; border-radius: 5px; font-size: 13px; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .fps-display { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 13px; display: flex; gap: 12px; }
        .fps-value { color: #00ff00; }
        .fps-value.low { color: #ff0000; }
        .fps-value.medium { color: #ffff00; }
        .scan-rate { color: #00bfff; }
        /* STATS */
        .stats { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 8px 12px; text-align: center; display: flex; justify-content: center; align-items: center; gap: 8px; flex-shrink: 0; flex-wrap: wrap; }
        .stats-title { font-size: 14px; }
        .stats-count { font-size: 18px; font-weight: bold; }
        .stats-total { font-size: 13px; opacity: 0.9; }
        /* HISTORY */
        .history { padding: 8px 12px; background: #16213e; flex-shrink: 0; max-height: 180px; display: flex; flex-direction: column; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .history-header h3 { font-size: 14px; color: #fff; }
        .search-input { padding: 5px 10px; border: 1px solid #3a4f6f; border-radius: 10px; font-size: 12px; width: 100px; background: #1a1a2e; color: white; }
        .history-list { border: 1px solid #2a3f5f; border-radius: 5px; overflow-y: auto; background: #1a1a2e; flex: 1; max-height: 130px; }
        .history-list::-webkit-scrollbar { width: 6px; }
        .history-list::-webkit-scrollbar-track { background: #2a3f5f; }
        .history-list::-webkit-scrollbar-thumb { background: #667eea; border-radius: 3px; }
        .history-item { display: grid; grid-template-columns: 28px 1fr 70px 50px 50px 50px 30px; gap: 4px; padding: 6px 8px; border-bottom: 1px solid #2a3f5f; font-size: 12px; align-items: center; }
        .history-item:hover { background: #1f2b47; }
        .h-num { color: #666; }
        .h-qr { font-weight: 600; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .h-date { color: #888; font-size: 10px; }
        .h-time { color: #667eea; }
        .h-duration { color: #28a745; }
        .h-size { color: #f39c12; }
        .h-products { color: #e74c3c; font-weight: 600; }
        .empty-msg { text-align: center; padding: 15px; color: #666; font-size: 13px; }
        /* HISTORY ACTIONS */
        .history-actions { display: flex; gap: 6px; padding: 6px 12px; background: #0d1520; justify-content: center; flex-shrink: 0; }
        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: #1a1a2e; border: 1px solid #3a4f6f; border-radius: 10px; padding: 15px; width: 90%; max-width: 300px; text-align: center; }
        .modal-box h3 { margin-bottom: 12px; color: #fff; font-size: 15px; }
        .modal-box .date-inputs { display: flex; gap: 8px; margin-bottom: 12px; flex-direction: column; }
        .modal-box .date-inputs label { font-size: 12px; color: #aaa; text-align: left; }
        .modal-box .date-inputs input { padding: 8px; border: 1px solid #3a4f6f; border-radius: 5px; background: #0d1520; color: white; font-size: 13px; }
        .modal-box .modal-buttons { display: flex; gap: 8px; justify-content: center; }
        /* TOAST */
        .toast { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; opacity: 0; transition: all 0.3s; z-index: 2000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .toast.warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .toast.error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header"><h1>üì¶ Order Packing Video Recording</h1><div class="subtitle">v7.17 - Full Screen | Free Edition</div></div>
        <div class="tabs"><button class="tab active" id="tabCamera">üì∑ Camera</button><button class="tab" id="tabScanner">‚å®Ô∏è Barcode Scanner</button></div>
        <div class="controls">
            <div class="control-row">
                <div class="control-group"><label>üìπ Camera</label><select id="cameraSelect"><option>Loading...</option></select></div>
                <div class="control-group"><label>üìê Quality</label><select id="qualitySelect"><option value="1080p30">1080p 30fps</option><option value="1080p60" selected>1080p 60fps</option></select></div>
                <div class="control-group"><label>üíæ Bitrate</label><select id="bitrateSelect"><option value="8">8 Mbps</option><option value="10">10 Mbps</option><option value="12" selected>12 Mbps</option></select></div>
            </div>
            <div class="control-row">
                <div class="control-group"><label>üìç Timestamp</label><select id="timestampPosition"><option value="top-left">Top Left</option><option value="top-right" selected>Top Right</option><option value="bottom-left">Bottom Left</option><option value="bottom-right">Bottom Right</option></select></div>
                <div class="control-group"><label>‚è™ Pre-scan Buffer</label><select id="preBufferSelect"><option value="3000">3 sec</option><option value="5000" selected>5 sec</option><option value="7000">7 sec</option><option value="10000">10 sec</option></select></div>
                <div class="control-group"><label>‚è© Post-scan Buffer</label><select id="postBufferSelect"><option value="2000">2 sec</option><option value="3000" selected>3 sec</option><option value="5000">5 sec</option></select></div>
            </div>
            <div class="toggle-row">
                <label class="toggle"><input type="checkbox" id="audioToggle" checked><span class="toggle-slider"></span></label>
                <span class="toggle-label">üé§ Record Audio</span>
            </div>
        </div>
        <div class="buttons"><button id="startBtn" class="btn btn-primary">üé¨ Start</button><button id="stopBtn" class="btn btn-danger hidden">‚èπÔ∏è Stop</button><button id="folderBtn" class="btn btn-secondary">üìÅ Folder</button></div>
        <div class="folder-info hidden" id="folderInfo"><div class="title">üìÅ Saving to:</div><div class="path" id="folderPath">Downloads/</div></div>
        <div class="video-section">
            <video id="webcamVideo" autoplay playsinline muted></video>
            <div class="video-overlay" id="orderInfo"><h4>üì¶ Recording</h4><div>Code: <strong id="currentQRDisplay">-</strong></div><div>Time: <span id="currentTime">00:00:00</span> | Items: <span id="productsCount">0</span></div></div>
            <div class="rec-indicator hidden" id="recIndicator">‚è∫ REC <span id="recTime">00:00</span></div>
            <div class="fps-display hidden" id="fpsDisplay"><span>FPS: <span id="fpsValue" class="fps-value">0</span></span><span>Scan: <span id="scanRate" class="scan-rate">0</span>/s</span></div>
        </div>
        <div class="stats">
            <span class="stats-title">üìä Today:</span>
            <span class="stats-count"><span id="todayCount">0</span> orders</span>
            <span class="stats-total">| Total: <span id="totalCount">0</span>/<span id="maxOrders">100000</span></span>
        </div>
        <div class="history"><div class="history-header"><h3>üìú History (<span id="historyCount">0</span>)</h3><input type="text" class="search-input" id="searchInput" placeholder="üîç Search..."></div><div class="history-list" id="historyList"><div class="empty-msg">No history yet</div></div></div>
        <div class="history-actions"><button id="exportBtn" class="btn btn-success btn-small">üìä Export CSV</button><button id="deleteByDateBtn" class="btn btn-info btn-small">üìÖ Delete by Date</button><button id="deleteAllBtn" class="btn btn-danger btn-small">üóëÔ∏è Clear All</button></div>
    </div>
    <div class="modal-overlay hidden" id="deleteModal"><div class="modal-box"><h3>üìÖ Delete Orders by Date</h3><div class="date-inputs"><div><label>From:</label><input type="date" id="deleteFromDate"></div><div><label>To:</label><input type="date" id="deleteToDate"></div></div><div class="modal-buttons"><button class="btn btn-secondary btn-small" id="cancelDeleteBtn">Cancel</button><button class="btn btn-danger btn-small" id="confirmDeleteBtn">üóëÔ∏è Delete</button></div></div></div>
    <div id="toast" class="toast"></div>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
(function(){var STORAGE_KEY='orderPackingVideoV7',MAX_ORDERS=100000,AUTO_DELETE_DAYS=60,SCAN_LOCK_FIRST=10000,SCAN_LOCK_SECOND=2000,PROGRESS_DISPLAY_TIME=1500;var VIDEO_PRESETS={'1080p30':{width:1920,height:1080,fps:30,scanFPS:3,scanScale:0.5},'1080p60':{width:1920,height:1080,fps:60,scanFPS:3,scanScale:0.5}};var BITRATE_OPTIONS={'8':{value:8000000},'10':{value:10000000},'12':{value:12000000}};var state={stream:null,recorder:null,chunks:[],canvasStream:null,orders:[],isRecording:false,isFirstScan:true,currentQR:null,scanBlocked:false,recordingStartTime:null,scanTime:null,timerInterval:null,countdownTimer:null,quality:'1080p60',bitrate:'12',audio:true,preBuf:5000,postBuf:3000,cameraId:null,device:'camera',timestampPos:'top-right',recordingCanvas:null,recordingCtx:null,scanCanvas:null,scanCtx:null,rafId:null,frameCount:0,lastFpsTime:0,currentFPS:0,lastScanTime:0,scanInterval:333,actualScanCount:0,lastScanCountTime:0,actualScanRate:0,displayQR:null,displayTime:0,detectedProducts:[],currentCodec:null,folderHandle:null,lastSavedFile:null,scanCycleCount:0};function $(id){return document.getElementById(id);}function toast(msg,type){var t=$('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(function(){t.classList.remove('show');},2500);}function beep(){try{var ctx=new(window.AudioContext||window.webkitAudioContext)();var o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.frequency.value=800;o.type='square';g.gain.setValueAtTime(0.3,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.1);o.start();o.stop(ctx.currentTime+0.1);}catch(e){}}function pad(n){return String(n).padStart(2,'0');}function formatTime(sec){return pad(Math.floor(sec/3600))+':'+pad(Math.floor((sec%3600)/60))+':'+pad(sec%60);}function dateStr(){var d=new Date();return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}function dateStrUS(){var d=new Date();return pad(d.getMonth()+1)+'/'+pad(d.getDate())+'/'+d.getFullYear();}function timeStr(){var d=new Date();return pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds());}function fileTimeStr(){var d=new Date();return pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds());}function usDateToISO(usDate){var p=usDate.split('/');return p.length===3?p[2]+'-'+p[0]+'-'+p[1]:usDate;}function getCodec(){var codecs=[{mimeType:'video/webm;codecs=vp8,opus',ext:'webm',name:'VP8'},{mimeType:'video/webm;codecs=vp8',ext:'webm',name:'VP8'},{mimeType:'video/webm',ext:'webm',name:'WebM'}];for(var i=0;i<codecs.length;i++){if(MediaRecorder.isTypeSupported(codecs[i].mimeType)){state.currentCodec=codecs[i];return codecs[i];}}state.currentCodec={mimeType:'video/webm',ext:'webm',name:'WebM'};return state.currentCodec;}function setupCanvas(){var preset=VIDEO_PRESETS[state.quality];if(!state.recordingCanvas){state.recordingCanvas=document.createElement('canvas');state.recordingCtx=state.recordingCanvas.getContext('2d',{alpha:false});}state.recordingCanvas.width=preset.width;state.recordingCanvas.height=preset.height;if(!state.scanCanvas){state.scanCanvas=document.createElement('canvas');state.scanCtx=state.scanCanvas.getContext('2d',{willReadFrequently:true});}state.scanCanvas.width=Math.round(preset.width*preset.scanScale);state.scanCanvas.height=Math.round(preset.height*preset.scanScale);state.scanInterval=Math.round(1000/preset.scanFPS);state.frameCount=0;state.lastFpsTime=0;state.currentFPS=0;}
function renderLoop(timestamp){if(!state.stream||!state.stream.active){state.rafId=null;return;}var video=$('webcamVideo');var ctx=state.recordingCtx;var canvas=state.recordingCanvas;if(!video||!ctx||video.readyState<2){state.rafId=requestAnimationFrame(renderLoop);return;}ctx.drawImage(video,0,0,canvas.width,canvas.height);drawTimestamp(ctx);if(state.displayQR&&(Date.now()-state.displayTime<PROGRESS_DISPLAY_TIME)){drawProgressBar(ctx,state.displayQR);}drawFPSCounter(ctx,timestamp);if(state.scanTime&&state.audio)drawAudioIndicator(ctx);var now=performance.now();if(now-state.lastScanTime>=state.scanInterval){state.lastScanTime=now;state.actualScanCount++;if(state.device==='camera'&&!state.scanBlocked&&state.isRecording){scanQRCode();}}if(now-state.lastScanCountTime>=1000){state.actualScanRate=state.actualScanCount;state.actualScanCount=0;state.lastScanCountTime=now;var scanEl=$('scanRate');if(scanEl)scanEl.textContent=state.actualScanRate;}state.rafId=requestAnimationFrame(renderLoop);}function drawTimestamp(ctx){var now=new Date();var text=now.toLocaleDateString('en-US')+' '+now.toLocaleTimeString('en-US');var position=state.timestampPos,canvas=state.recordingCanvas,margin=113;ctx.font='bold 22px Arial';ctx.fillStyle='white';ctx.strokeStyle='black';ctx.lineWidth=3;var x=position.includes('left')?margin:canvas.width-280-margin;var y=position.includes('top')?margin+22:canvas.height-margin;ctx.strokeText(text,x,y);ctx.fillText(text,x,y);if(state.scanTime){var blink=Math.floor(Date.now()/500)%2;var recY=position.includes('top')?margin+57:canvas.height-margin-35;if(blink){ctx.fillStyle='red';ctx.beginPath();ctx.arc(margin+15,recY,12,0,2*Math.PI);ctx.fill();}ctx.fillStyle='white';ctx.font='bold 18px Arial';ctx.fillText('REC',margin+35,recY+6);}}function drawProgressBar(ctx,qrCode){var position=state.timestampPos,canvas=state.recordingCanvas,margin=113;var panelWidth=500,panelHeight=180;var panelX=position.includes('left')?margin:canvas.width-panelWidth-margin;var panelY=position.includes('top')?margin+80:canvas.height-margin-panelHeight-80;var centerX=panelX+panelWidth/2;ctx.fillStyle='rgba(0,0,0,0.85)';ctx.fillRect(panelX,panelY,panelWidth,panelHeight);ctx.strokeStyle='#00FF00';ctx.lineWidth=3;ctx.strokeRect(panelX,panelY,panelWidth,panelHeight);ctx.fillStyle='#00FF00';ctx.font='bold 24px Arial';ctx.textAlign='center';ctx.fillText('‚úÖ QR CODE DETECTED',centerX,panelY+30);ctx.fillStyle='#FFD700';ctx.font='bold 28px Arial';ctx.fillText(qrCode.length>20?qrCode.substring(0,20)+'...':qrCode,centerX,panelY+65);var barX=panelX+20,barY=panelY+120,barWidth=panelWidth-40,barHeight=35;ctx.fillStyle='rgba(50,50,50,0.9)';ctx.fillRect(barX,barY,barWidth,barHeight);ctx.fillStyle='#00FF00';ctx.fillRect(barX,barY,barWidth,barHeight);ctx.fillStyle='#FFFFFF';ctx.font='bold 20px Arial';ctx.fillText('100%',centerX,barY+barHeight/2+7);if(state.detectedProducts.length>0){ctx.fillStyle='#00BFFF';ctx.font='bold 14px Arial';ctx.fillText('üì¶ '+state.detectedProducts.length+' items',centerX,panelY+panelHeight-15);}ctx.textAlign='left';}function drawFPSCounter(ctx,timestamp){state.frameCount++;if(state.lastFpsTime===0)state.lastFpsTime=timestamp;var elapsed=timestamp-state.lastFpsTime;if(elapsed>=1000){state.currentFPS=Math.round(state.frameCount*1000/elapsed);state.frameCount=0;state.lastFpsTime=timestamp;var fpsEl=$('fpsValue');if(fpsEl){fpsEl.textContent=state.currentFPS;fpsEl.className='fps-value '+(state.currentFPS<30?'low':state.currentFPS<50?'medium':'');}}var margin=113,position=state.timestampPos;var y=position.includes('bottom')?margin+20:state.recordingCanvas.height-margin;ctx.fillStyle=state.currentFPS<30?'#FF0000':state.currentFPS<50?'#FFFF00':'#00FF00';ctx.font='bold 14px Arial';ctx.fillText('FPS: '+state.currentFPS,margin,y);ctx.fillStyle='#00BFFF';ctx.fillText('Scan: '+state.actualScanRate+'/s',margin+80,y);}function drawAudioIndicator(ctx){var margin=113,position=state.timestampPos;var y=position.includes('bottom')?margin+45:state.recordingCanvas.height-margin-25;ctx.fillStyle='#FF0000';ctx.font='bold 14px Arial';ctx.fillText('üé§ REC',margin,y);}
function scanQRCode(){try{var video=$('webcamVideo');if(!video||video.readyState<2)return;var ctx=state.scanCtx,canvas=state.scanCanvas;if(!ctx||!canvas)return;ctx.drawImage(video,0,0,canvas.width,canvas.height);var imageData=ctx.getImageData(0,0,canvas.width,canvas.height);if(!imageData||typeof jsQR==='undefined')return;var code=jsQR(imageData.data,imageData.width,imageData.height,{inversionAttempts:'dontInvert'});if(code&&code.data&&code.data.trim()){var qrData=code.data.trim();state.displayQR=qrData;state.displayTime=Date.now();if(state.scanTime&&state.detectedProducts.indexOf(qrData)===-1){state.detectedProducts.push(qrData);$('productsCount').textContent=state.detectedProducts.length;}if(!state.scanBlocked){handleQRDetected(qrData);}}}catch(e){}}function handleQRDetected(qrData){if(!qrData||state.scanBlocked)return;beep();if(state.isFirstScan){state.currentQR=qrData;state.isFirstScan=false;state.scanTime=Date.now();state.detectedProducts=[qrData];state.scanBlocked=true;var recordedMs=state.scanTime-state.recordingStartTime;var effectivePreBuffer=Math.min(state.preBuf,recordedMs);$('currentQRDisplay').textContent=qrData;$('productsCount').textContent='1';$('orderInfo').classList.add('show');$('recIndicator').classList.remove('hidden');startDisplayTimer(effectivePreBuffer);toast('üìπ Recording (+'+Math.round(effectivePreBuffer/1000)+'s): '+qrData,'success');if(state.countdownTimer){clearInterval(state.countdownTimer);state.countdownTimer=null;}var countdown=10;state.countdownTimer=setInterval(function(){countdown--;if(countdown>0){toast('‚è±Ô∏è Wait '+countdown+'s...','warning');}else{clearInterval(state.countdownTimer);state.countdownTimer=null;state.scanBlocked=false;toast('‚úÖ Scan again to finish!','success');}},1000);}else{if(qrData!==state.currentQR){toast('‚ö†Ô∏è Code mismatch!','error');return;}state.scanBlocked=true;startPostBuffer();}}function startRecording(){if(!state.stream||!state.stream.active)return;if(state.recorder){try{if(state.recorder.state!=='inactive')state.recorder.stop();}catch(e){}state.recorder=null;}setupCanvas();var preset=VIDEO_PRESETS[state.quality],bitrate=BITRATE_OPTIONS[state.bitrate].value;if(state.canvasStream){state.canvasStream.getTracks().forEach(function(t){t.stop();});}state.canvasStream=state.recordingCanvas.captureStream(preset.fps);if(state.audio&&state.stream.getAudioTracks().length>0){state.stream.getAudioTracks().forEach(function(track){state.canvasStream.addTrack(track.clone());});}var codec=getCodec();try{state.recorder=new MediaRecorder(state.canvasStream,{mimeType:codec.mimeType,videoBitsPerSecond:bitrate});}catch(e){state.recorder=new MediaRecorder(state.canvasStream);}state.chunks=[];state.recorder.ondataavailable=function(e){if(e.data&&e.data.size>0)state.chunks.push(e.data);};state.recorder.onstop=function(){saveRecording();};state.recorder.start(1000);state.isRecording=true;state.recordingStartTime=Date.now();if(state.rafId){cancelAnimationFrame(state.rafId);state.rafId=null;}state.rafId=requestAnimationFrame(renderLoop);$('fpsDisplay').classList.remove('hidden');}function stopRecordingOnly(){if(state.recorder&&state.recorder.state==='recording'){state.recorder.stop();}}function startPostBuffer(){var postBufferSec=Math.round(state.postBuf/1000);toast('üì¶ +'+postBufferSec+'s...','success');$('recIndicator').classList.add('hidden');$('orderInfo').classList.remove('show');if(state.countdownTimer){clearInterval(state.countdownTimer);state.countdownTimer=null;}var countdown=postBufferSec;var postTimer=setInterval(function(){countdown--;if(countdown<=0){clearInterval(postTimer);stopRecordingOnly();}},1000);}
async function saveRecording(){var qrCode=state.currentQR;if(!qrCode||state.chunks.length===0){restartForNextOrder();return;}var ext=state.currentCodec?state.currentCodec.ext:'webm';var mimeType=state.currentCodec?state.currentCodec.mimeType:'video/webm';var filename=qrCode+'_'+dateStr()+'_'+fileTimeStr()+'.'+ext;var blob=new Blob(state.chunks,{type:mimeType});var sizeMB=(blob.size/1048576).toFixed(2);var duration=state.chunks.length;await saveVideo(blob,filename);state.lastSavedFile=filename;updateFolderInfo(filename);var order={qr:qrCode,date:dateStrUS(),time:timeStr(),duration:formatTime(duration),filename:filename,size:sizeMB+'MB',productsDetected:state.detectedProducts.length,timestamp:Date.now()};state.orders.unshift(order);if(state.orders.length>MAX_ORDERS)state.orders.pop();localStorage.setItem(STORAGE_KEY,JSON.stringify(state.orders));updateUI();state.scanCycleCount++;toast('‚úÖ Saved: '+qrCode+' ('+sizeMB+'MB) #'+state.scanCycleCount,'success');setTimeout(restartForNextOrder,SCAN_LOCK_SECOND);}async function saveVideo(blob,filename){if(state.folderHandle){try{var fileHandle=await state.folderHandle.getFileHandle(filename,{create:true});var writable=await fileHandle.createWritable();await writable.write(blob);await writable.close();return;}catch(e){}}var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);setTimeout(function(){URL.revokeObjectURL(url);},1000);}function updateFolderInfo(filename){$('folderPath').textContent=(state.folderHandle?state.folderHandle.name+'/':'Downloads/')+filename;$('folderInfo').classList.remove('hidden');}function restartForNextOrder(){if(state.timerInterval){clearInterval(state.timerInterval);state.timerInterval=null;}if(state.countdownTimer){clearInterval(state.countdownTimer);state.countdownTimer=null;}if(state.rafId){cancelAnimationFrame(state.rafId);state.rafId=null;}state.isFirstScan=true;state.currentQR=null;state.scanTime=null;state.scanBlocked=false;state.detectedProducts=[];state.displayQR=null;state.displayTime=0;state.chunks=[];state.recorder=null;state.isRecording=false;$('orderInfo').classList.remove('show');$('recIndicator').classList.add('hidden');if(state.stream&&state.stream.active){startRecording();toast('üîÑ Ready for #'+(state.scanCycleCount+1),'success');}}function startDisplayTimer(preBufferMs){var displayTime=Math.floor(preBufferMs/1000);if(state.timerInterval)clearInterval(state.timerInterval);state.timerInterval=setInterval(function(){displayTime++;var timeString=formatTime(displayTime);var recTime=$('recTime');if(recTime)recTime.textContent=timeString.substring(3);var curTimer=$('currentTime');if(curTimer)curTimer.textContent=timeString;},1000);}
function getCameras(){navigator.mediaDevices.enumerateDevices().then(function(devs){var cams=devs.filter(function(d){return d.kind==='videoinput';});var sel=$('cameraSelect');sel.innerHTML='';cams.forEach(function(c,i){var opt=document.createElement('option');opt.value=c.deviceId;opt.textContent=c.label||'Camera '+(i+1);sel.appendChild(opt);});if(cams.length&&!state.cameraId)state.cameraId=cams[0].deviceId;var saved=localStorage.getItem('camera');if(saved&&cams.find(function(c){return c.deviceId===saved;})){state.cameraId=saved;sel.value=saved;}});}function startCamera(){var preset=VIDEO_PRESETS[state.quality];navigator.mediaDevices.getUserMedia({video:{deviceId:state.cameraId?{exact:state.cameraId}:undefined,width:{ideal:preset.width},height:{ideal:preset.height},frameRate:{ideal:preset.fps,min:30}},audio:state.audio}).then(function(stream){state.stream=stream;$('webcamVideo').srcObject=stream;$('startBtn').classList.add('hidden');$('stopBtn').classList.remove('hidden');state.scanCycleCount=0;state.isFirstScan=true;state.currentQR=null;state.scanBlocked=false;state.scanTime=null;state.detectedProducts=[];state.chunks=[];setTimeout(startRecording,500);toast('‚úÖ Camera ON');getCameras();}).catch(function(e){toast('‚ùå Error: '+e.message,'error');});}function stopCamera(){if(state.timerInterval){clearInterval(state.timerInterval);state.timerInterval=null;}if(state.countdownTimer){clearInterval(state.countdownTimer);state.countdownTimer=null;}if(state.rafId){cancelAnimationFrame(state.rafId);state.rafId=null;}if(state.recorder&&state.recorder.state==='recording'){try{state.recorder.stop();}catch(e){}}state.recorder=null;state.isRecording=false;if(state.canvasStream){state.canvasStream.getTracks().forEach(function(t){t.stop();});state.canvasStream=null;}if(state.stream){state.stream.getTracks().forEach(function(t){t.stop();});state.stream=null;}$('webcamVideo').srcObject=null;$('startBtn').classList.remove('hidden');$('stopBtn').classList.add('hidden');$('fpsDisplay').classList.add('hidden');$('orderInfo').classList.remove('show');$('recIndicator').classList.add('hidden');state.scanBlocked=false;state.isFirstScan=true;state.currentQR=null;state.chunks=[];toast('Camera OFF','warning');}async function openFolder(){var folderInfo=$('folderInfo'),folderPath=$('folderPath');if(!folderInfo.classList.contains('hidden')){folderInfo.classList.add('hidden');return;}folderPath.textContent=state.lastSavedFile?'Downloads/'+state.lastSavedFile:'Downloads/';folderInfo.classList.remove('hidden');if('showDirectoryPicker' in window){try{state.folderHandle=await window.showDirectoryPicker({mode:'readwrite',startIn:'downloads'});folderPath.textContent=state.folderHandle.name+'/';toast('‚úÖ Selected: '+state.folderHandle.name,'success');}catch(e){}}}
function updateUI(){var today=dateStr();var todayOrders=state.orders.filter(function(o){return usDateToISO(o.date)===today;});$('todayCount').textContent=todayOrders.length;$('totalCount').textContent=state.orders.length.toLocaleString();$('maxOrders').textContent=MAX_ORDERS.toLocaleString();$('historyCount').textContent=state.orders.length.toLocaleString();renderHistory();}function renderHistory(search){var list=$('historyList');var filtered=search?state.orders.filter(function(o){return o.qr.toLowerCase().indexOf(search.toLowerCase())!==-1;}):state.orders;if(!filtered.length){list.innerHTML='<div class="empty-msg">No history yet</div>';return;}var html='';filtered.forEach(function(o,i){html+='<div class="history-item"><span class="h-num">#'+(i+1)+'</span><span class="h-qr">'+o.qr+'</span><span class="h-date">'+o.date+'</span><span class="h-time">'+o.time+'</span><span class="h-duration">'+o.duration+'</span><span class="h-size">'+(o.size||'-')+'</span><span class="h-products">'+(o.productsDetected||0)+'</span></div>';});list.innerHTML=html;}function exportExcel(){if(!state.orders.length){toast('No data to export','warning');return;}var csv='\uFEFF'+['#','QR Code','Date','Time','Duration','Size','Items','Filename'].join(',')+'\n';state.orders.forEach(function(o,i){csv+=[i+1,'"'+o.qr+'"',o.date,o.time,o.duration,o.size||'-',o.productsDetected||0,o.filename].join(',')+'\n';});var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='OrderPacking_'+dateStr()+'.csv';a.click();toast('‚úÖ Exported: '+state.orders.length+' orders','success');}function showDeleteModal(){var today=new Date(),lastWeek=new Date(today.getTime()-7*86400000);$('deleteFromDate').value=lastWeek.toISOString().split('T')[0];$('deleteToDate').value=today.toISOString().split('T')[0];$('deleteModal').classList.remove('hidden');}function hideDeleteModal(){$('deleteModal').classList.add('hidden');}function deleteByDate(){var fromDate=$('deleteFromDate').value,toDate=$('deleteToDate').value;if(!fromDate||!toDate){toast('Select dates','warning');return;}var beforeCount=state.orders.length;state.orders=state.orders.filter(function(o){var isoDate=usDateToISO(o.date);return isoDate<fromDate||isoDate>toDate;});var deletedCount=beforeCount-state.orders.length;if(deletedCount>0){localStorage.setItem(STORAGE_KEY,JSON.stringify(state.orders));updateUI();toast('‚úÖ Deleted '+deletedCount+' orders','success');}else{toast('No orders found','warning');}hideDeleteModal();}function deleteAll(){if(confirm('Delete all '+state.orders.length+' orders?')){state.orders=[];localStorage.setItem(STORAGE_KEY,'[]');updateUI();toast('‚úÖ All cleared','success');}}function autoDelete(){var cutoff=Date.now()-AUTO_DELETE_DAYS*86400000;var before=state.orders.length;state.orders=state.orders.filter(function(o){return o.timestamp&&o.timestamp>cutoff;});if(state.orders.length<before){localStorage.setItem(STORAGE_KEY,JSON.stringify(state.orders));console.log('[AutoDelete] Removed '+(before-state.orders.length)+' orders older than '+AUTO_DELETE_DAYS+' days');}}var barcodeBuffer='',barcodeTimer=null;function handleKeydown(e){if(state.device!=='scanner')return;if(barcodeTimer)clearTimeout(barcodeTimer);if(e.key==='Enter'){if(barcodeBuffer.length>3&&!state.scanBlocked)handleQRDetected(barcodeBuffer);barcodeBuffer='';}else if(e.key.length===1){barcodeBuffer+=e.key;}barcodeTimer=setTimeout(function(){barcodeBuffer='';},100);}
function init(){try{var saved=localStorage.getItem(STORAGE_KEY);if(saved)state.orders=JSON.parse(saved);}catch(e){}autoDelete();state.quality=localStorage.getItem('quality')||'1080p60';state.bitrate=localStorage.getItem('bitrate')||'12';state.audio=localStorage.getItem('audio')!=='false';state.preBuf=parseInt(localStorage.getItem('preBuf'))||5000;state.postBuf=parseInt(localStorage.getItem('postBuf'))||3000;state.timestampPos=localStorage.getItem('timestampPos')||'top-right';$('qualitySelect').value=state.quality;$('bitrateSelect').value=state.bitrate;$('audioToggle').checked=state.audio;$('preBufferSelect').value=state.preBuf;$('postBufferSelect').value=state.postBuf;$('timestampPosition').value=state.timestampPos;$('scanRate').textContent=VIDEO_PRESETS[state.quality].scanFPS;updateUI();$('startBtn').onclick=startCamera;$('stopBtn').onclick=stopCamera;$('folderBtn').onclick=openFolder;$('exportBtn').onclick=exportExcel;$('deleteByDateBtn').onclick=showDeleteModal;$('deleteAllBtn').onclick=deleteAll;$('cancelDeleteBtn').onclick=hideDeleteModal;$('confirmDeleteBtn').onclick=deleteByDate;$('tabCamera').onclick=function(){state.device='camera';$('tabCamera').classList.add('active');$('tabScanner').classList.remove('active');};$('tabScanner').onclick=function(){state.device='scanner';$('tabScanner').classList.add('active');$('tabCamera').classList.remove('active');};$('searchInput').oninput=function(e){renderHistory(e.target.value);};$('cameraSelect').onchange=function(){state.cameraId=this.value;localStorage.setItem('camera',this.value);if(state.stream){stopCamera();setTimeout(startCamera,300);}};$('qualitySelect').onchange=function(){state.quality=this.value;localStorage.setItem('quality',this.value);$('scanRate').textContent=VIDEO_PRESETS[this.value].scanFPS;if(state.stream){stopCamera();setTimeout(startCamera,300);}};$('bitrateSelect').onchange=function(){state.bitrate=this.value;localStorage.setItem('bitrate',this.value);};$('timestampPosition').onchange=function(){state.timestampPos=this.value;localStorage.setItem('timestampPos',this.value);};$('preBufferSelect').onchange=function(){state.preBuf=parseInt(this.value);localStorage.setItem('preBuf',this.value);};$('postBufferSelect').onchange=function(){state.postBuf=parseInt(this.value);localStorage.setItem('postBuf',this.value);};$('audioToggle').onchange=function(){state.audio=this.checked;localStorage.setItem('audio',this.checked);if(state.stream){stopCamera();setTimeout(startCamera,300);}};document.addEventListener('keydown',handleKeydown);$('deleteModal').onclick=function(e){if(e.target===this)hideDeleteModal();};setTimeout(function(){navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(function(s){s.getTracks().forEach(function(t){t.stop();});getCameras();}).catch(function(){getCameras();});},500);toast('‚úÖ v7.17 Ready','success');}if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();})();
    </script>
</body>
</html>
